{% load static %}
<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>InsightDocs AI Â· Chat</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Plus+Jakarta+Sans:wght@500;600;700;800&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23a78bfa;stop-opacity:1'/%3E%3Cstop offset='100%25' style='stop-color:%237c3aed;stop-opacity:1'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect x='0' y='0' width='64' height='64' rx='16' fill='%23020617'/%3E%3Cpath d='M32 14L50 23V41L32 50L14 41V23Z' fill='url(%23g)' stroke='%23ddd6fe' stroke-width='2'/%3E%3Cpath d='M32 50V32M32 32L50 23M32 32L14 23' stroke='%23ddd6fe' stroke-width='2'/%3E%3C/svg%3E" type="image/svg+xml">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.2); }
        
        /* Modern Grid Background */
        .bg-modern-grid {
            background-color: #020617; 
            background-image: 
                radial-gradient(at 0% 0%, rgba(124, 58, 237, 0.08) 0px, transparent 50%), 
                radial-gradient(at 100% 100%, rgba(59, 130, 246, 0.08) 0px, transparent 50%), 
                linear-gradient(rgba(255, 255, 255, 0.02) 1px, transparent 1px), 
                linear-gradient(90deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px);
            background-size: 100% 100%, 100% 100%, 40px 40px, 40px 40px;
            background-position: center;
        }

        .glass-header {
            background: rgba(2, 6, 23, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .glass-input-container {
            background: linear-gradient(to top, #020617 20%, rgba(2, 6, 23, 0) 100%);
        }

        /* Animation for Messages */
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .msg-animate { animation: slideIn 0.35s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        /* Typing Dots Animation */
        .typing-indicator { display: flex; gap: 4px; padding: 4px; }
        .typing-indicator span {
            width: 4px; height: 4px; border-radius: 50%;
            background: rgba(255, 255, 255, 0.6);
            animation: typing 1.4s infinite;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 60%, 100% { opacity: 0.3; transform: translateY(0); }
            30% { opacity: 1; transform: translateY(-3px); }
        }

        /* Markdown Styles */
        .markdown-body p { margin-bottom: 0.75rem; }
        .markdown-body p:last-child { margin-bottom: 0; }
        .markdown-body ul { list-style-type: disc; margin-left: 1.5rem; margin-bottom: 0.75rem; }
        .markdown-body ol { list-style-type: decimal; margin-left: 1.5rem; margin-bottom: 0.75rem; }
        .markdown-body strong { font-weight: 700; color: #fff; }
        .markdown-body pre { 
            background: #18181b; padding: 0.75rem; border-radius: 0.5rem; overflow-x: auto; 
            margin-bottom: 0.75rem; border: 1px solid rgba(255,255,255,0.1);
        }
        .markdown-body code { 
            font-family: monospace; background: rgba(255,255,255,0.1); 
            padding: 0.1rem 0.3rem; border-radius: 0.25rem; font-size: 0.85em;
        }
        .markdown-body pre code { background: transparent; padding: 0; color: #e2e8f0; }
        .markdown-body a { color: #a78bfa; text-decoration: underline; }

        /* Sidebar Transition */
        #sidebar {
            transition-property: width, transform;
            transition-duration: 300ms;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        }
        .sidebar-collapsed { width: 0 !important; overflow: hidden; border-right: 0 !important; }

        /* Status Dot Pulse */
        @keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .status-dot.connecting { animation: pulse-dot 1.5s infinite; background-color: #3b82f6; }
        .status-dot.connected { background-color: #22c55e; }
        .status-dot.disconnected { background-color: #ef4444; }
        .status-dot { width: 6px; height: 6px; border-radius: 50%; display: inline-block; }

        @media (max-width: 1023px) {
            #doc-view-wrapper.mobile-active {
                display: flex !important; position: absolute; inset: 0; z-index: 30;
                width: 100%; border-left: none; background-color: rgba(2, 6, 23, 0.98);
            }
        }

        .tab-active { border-bottom: 2px solid #8b5cf6; color: white; }
        .tab-inactive { border-bottom: 2px solid transparent; color: #71717a; }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: { 
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Plus Jakarta Sans', 'sans-serif'],
                    },
                    colors: { gray: { 950: '#020617' } }
                }
            }
        }
    </script>
</head>
<body class="h-screen w-full overflow-hidden bg-gray-950 text-zinc-100 selection:bg-violet-500/30">

    <div id="mobile-backdrop" onclick="toggleMobileSidebar()" class="fixed inset-0 z-40 hidden bg-black/80 backdrop-blur-sm transition-opacity lg:hidden"></div>

    <div class="flex h-full w-full">

        <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 flex w-72 -translate-x-full flex-col border-r border-white/5 bg-gray-950 whitespace-nowrap lg:relative lg:translate-x-0">
            
            <div class="flex h-20 shrink-0 items-center justify-between border-b border-white/5 px-6">
                <a href="{% url 'upload' %}" class="flex items-center gap-3 group cursor-pointer">
                    <div class="relative w-8 h-8 flex items-center justify-center">
                        <div class="absolute inset-0 bg-violet-500 rounded-lg blur-sm opacity-50 group-hover:opacity-75 transition-opacity"></div>
                        <div class="relative w-full h-full bg-gradient-to-br from-violet-600 to-indigo-600 rounded-lg flex items-center justify-center border border-white/10">
                            <i class="fa-solid fa-cube text-white text-xs"></i>
                        </div>
                    </div>
                    <span class="font-display font-bold text-lg tracking-tight text-white">InsightDocs<span class="text-violet-400">.ai</span></span>
                </a>
                <button onclick="toggleMobileSidebar()" class="rounded-lg p-1 text-zinc-400 hover:bg-white/5 hover:text-white lg:hidden">
                    <i class="fa-solid fa-xmark text-lg"></i>
                </button>
            </div>

            <div class="flex flex-1 flex-col overflow-y-auto px-4 py-6 scrollbar-thin">
                <div class="mb-6 rounded-2xl border border-violet-500/20 bg-violet-500/5 p-4 shadow-inner shadow-violet-500/5">
                    <div class="mb-2 flex items-center gap-2 text-[10px] font-bold uppercase tracking-wider text-violet-400">
                        <span class="relative flex h-2 w-2">
                          <span class="absolute inline-flex h-full w-full animate-ping rounded-full bg-violet-400 opacity-75"></span>
                          <span class="relative inline-flex h-2 w-2 rounded-full bg-violet-500"></span>
                        </span>
                        Active Session
                    </div>
                    <p class="truncate font-semibold text-white">{{ document.title }}</p>
                    <p class="text-xs text-zinc-400">Updated {{ document.uploaded_at|timesince }} ago</p>
                </div>

                <a href="{% url 'upload' %}" class="group mb-8 flex w-full items-center justify-center gap-2 rounded-xl bg-white py-3 text-sm font-semibold text-black transition-all hover:bg-zinc-200 hover:shadow-lg hover:shadow-white/5">
                    <span>Start new chat</span>
                    <i class="fa-solid fa-plus text-xs transition-transform group-hover:rotate-90"></i>
                </a>

                <div class="space-y-1">
                    <div class="mb-2 flex items-center justify-between px-2 text-[10px] font-bold uppercase tracking-widest text-zinc-500">
                        <span>Recent History</span>
                    </div>
                    {% if recent_documents %}
                        {% for doc in recent_documents %}
                        <a href="{% url 'chat' doc.id %}" class="group block rounded-xl border border-transparent p-3 text-left transition-colors hover:bg-white/5">
                            <div class="flex items-center justify-between">
                                <span class="truncate text-sm text-zinc-300 group-hover:text-white">{{ doc.title }}</span>
                                <span class="text-[10px] text-zinc-500">{{ doc.extension|upper }}</span>
                            </div>
                            <p class="mt-1 text-xs text-zinc-500">{{ doc.uploaded_at|timesince }} ago</p>
                        </a>
                        {% endfor %}
                    {% else %}
                        <p class="rounded-xl border border-dashed border-white/5 p-3 text-xs text-zinc-500">Upload another file to see it here.</p>
                    {% endif %}
                </div>
            </div>

            <div class="border-t border-white/5 p-4">
                <div class="flex items-center gap-2 rounded-xl border border-white/5 bg-white/5 p-3">
                    <div class="flex h-9 w-9 items-center justify-center rounded-full bg-gradient-to-tr from-violet-500 to-fuchsia-500 text-xs font-bold text-white">
                        {{ request.user.get_full_name|default:request.user.username|slice:":2"|upper }}
                    </div>
                    <div class="flex-1 overflow-hidden px-1">
                        <p class="truncate text-sm font-medium text-white">{{ request.user.get_full_name|default:request.user.username }}</p>
                        <p class="truncate text-xs text-zinc-400">{{ request.user.email }}</p>
                    </div>
                    
                    <a href="{% url 'profile' %}" class="rounded-lg p-1.5 text-zinc-400 hover:bg-white/10 hover:text-white transition-colors" title="Profile Settings">
                        <i class="fa-solid fa-user-gear"></i>
                    </a>
                    
                    <form action="{% url 'logout' %}" method="post">
                        {% csrf_token %}
                        <button type="submit" class="rounded-lg p-1.5 text-zinc-400 hover:bg-red-500/10 hover:text-red-400 transition-colors" title="Log out">
                            <i class="fa-solid fa-arrow-right-from-bracket"></i>
                        </button>
                    </form>
                </div>
            </div>
        </aside>

        <main class="relative flex flex-1 flex-col overflow-hidden bg-modern-grid">
            
            <header class="glass-header z-20 flex h-16 shrink-0 items-center justify-between px-4 sm:px-6">
                <div class="flex items-center gap-3">
                    <button onclick="toggleMobileSidebar()" class="mr-1 rounded-lg p-2 text-zinc-400 hover:bg-white/10 lg:hidden">
                        <i class="fa-solid fa-bars text-lg"></i>
                    </button>
                    
                    <button onclick="toggleDesktopSidebar()" class="hidden rounded-lg p-2 text-zinc-400 hover:bg-white/10 hover:text-white lg:block" title="Toggle Sidebar">
                        <i id="toggle-icon" class="fa-solid fa-bars-staggered text-lg"></i>
                    </button>

                    <div class="flex flex-col border-l border-white/10 pl-4">
                        <h1 class="flex items-center gap-2 text-sm font-semibold text-white sm:text-base">
                            {{ document.title }}
                            <span class="hidden rounded-full bg-white/10 px-2 py-0.5 text-[10px] font-medium text-zinc-300 sm:inline-block">{{ document.extension|upper }}</span>
                        </h1>
                    </div>
                </div>

                <div class="flex items-center gap-3">
                    <div id="ws-status" class="flex items-center gap-2 rounded-full border border-white/5 bg-black/20 px-3 py-1 text-xs text-zinc-400 backdrop-blur-md">
                        <span class="status-dot connecting"></span>
                        <span class="hidden sm:inline">Connecting...</span>
                    </div>

                    <a href="{% url 'subscription' %}" class="hidden items-center gap-2 rounded-full bg-gradient-to-r from-violet-600 to-fuchsia-600 px-4 py-1.5 text-xs font-bold text-white shadow-lg shadow-violet-500/20 hover:scale-105 hover:shadow-violet-500/30 transition-all sm:flex">
                        Upgrade Pro
                    </a>
                </div>
            </header>

            <div class="flex h-12 w-full shrink-0 items-center justify-center border-b border-white/5 bg-gray-950/50 lg:hidden">
                <button onclick="switchMobileTab('chat')" id="tab-btn-chat" class="tab-active flex h-full flex-1 items-center justify-center text-xs font-medium transition-colors">Chat</button>
                <button onclick="switchMobileTab('doc')" id="tab-btn-doc" class="tab-inactive flex h-full flex-1 items-center justify-center text-xs font-medium transition-colors">Document</button>
            </div>

            <div class="flex flex-1 overflow-hidden relative">
                
                <div id="chat-view-wrapper" class="flex flex-1 flex-col relative h-full w-full">
                    
                    <div id="chat-container" class="flex-1 overflow-y-auto px-4 py-6 sm:px-8 scroll-smooth scrollbar-thin">
                        <div class="mx-auto max-w-3xl space-y-8 pb-32">
                            
                            <div class="flex items-center justify-center pb-2 opacity-80">
                                <div class="flex items-center gap-2 rounded-full border border-violet-500/30 bg-violet-500/10 px-3 py-1 text-xs text-violet-300 backdrop-blur">
                                    <i class="fa-solid fa-sparkles animate-pulse"></i>
                                    AI is ready to chat
                                </div>
                            </div>

                            <div id="chat-messages" class="space-y-6 flex flex-col">
                                {% for msg in chat_history %}
                                    <div class="w-full flex msg-animate {% if msg.role == 'user' %}justify-end{% else %}justify-start{% endif %}">
                                        <div class="relative px-5 py-3.5 rounded-2xl max-w-[85%] sm:max-w-[75%] text-sm leading-relaxed shadow-lg
                                            {% if msg.role == 'user' %}
                                                bg-gradient-to-br from-violet-600 to-indigo-600 text-white rounded-br-none
                                            {% else %}
                                                bg-zinc-900/70 backdrop-blur-md border border-white/10 text-zinc-100 markdown-body rounded-bl-none
                                            {% endif %}
                                        ">
                                            {% if msg.role == 'user' %}
                                                {{ msg.content|linebreaksbr }}
                                            {% else %}
                                                <div class="markdown-content">{{ msg.content }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <div class="absolute bottom-0 left-0 right-0 glass-input-container z-30 px-4 pb-6 pt-10">
                        <div class="mx-auto max-w-3xl">
                            <form id="chat-form" onsubmit="handleSendMessage(event)" 
                                  class="group relative flex items-end gap-2 rounded-[26px] border border-white/10 bg-zinc-900/80 p-2 shadow-2xl shadow-black/50 backdrop-blur-xl transition-all hover:border-white/20 focus-within:border-violet-500/50 focus-within:ring-1 focus-within:ring-violet-500/20">
                                
                                <div id="chat-input-container" class="flex-1 py-2 pl-4 min-h-[44px] max-h-32 overflow-y-auto">
                                    <textarea name="content" id="message-input" rows="1" 
                                        placeholder="Ask a question about your document..." required 
                                        class="w-full bg-transparent text-white outline-none border-none text-[15px] resize-none focus:ring-0 placeholder-zinc-500 leading-relaxed custom-textarea"></textarea>
                                </div>
                                
                                <button type="submit" id="send-btn" class="mb-1 mr-1 flex h-9 w-9 shrink-0 items-center justify-center rounded-full bg-violet-600 text-white shadow-lg shadow-violet-600/30 transition-all hover:bg-violet-500 hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                                    <i class="fa-solid fa-paper-plane text-xs translate-x-px translate-y-px"></i>
                                </button>
                            </form>
                            <p class="mt-2 text-center text-[10px] font-medium text-zinc-600">InsightDocs AI generated content.</p>
                        </div>
                    </div>
                </div>

                <aside id="doc-view-wrapper" class="hidden relative h-full w-full flex-col border-l border-white/5 bg-gray-950/70 backdrop-blur lg:flex lg:w-96 lg:relative shrink-0">
                    <div class="flex h-10 shrink-0 items-center justify-between border-b border-white/5 px-4 lg:h-12">
                        <h3 class="text-xs font-semibold text-white lg:text-sm">Document Preview</h3>
                        <div class="flex items-center gap-2">
                            <a href="{{ document.file.url }}" target="_blank" class="text-[10px] text-violet-400 hover:text-violet-300 lg:text-xs">
                                Open in New Tab <i class="fa-solid fa-arrow-up-right-from-square ml-1"></i>
                            </a>
                            <button type="button" onclick="switchMobileTab('chat')" class="lg:hidden rounded-full border border-white/10 px-2 py-0.5 text-[10px] font-medium text-zinc-200 hover:bg-white/10">Close</button>
                        </div>
                    </div>
                    
                    <div class="flex-1 overflow-hidden bg-zinc-900 relative group">
                        <iframe 
                            src="{{ document.file.url }}" 
                            class="absolute inset-0 h-full w-full border-none bg-white" 
                            title="Preview"
                            onerror="this.style.display='none'; document.getElementById('preview-error').style.display='flex';"
                        ></iframe>
                
                        <div id="preview-error" class="hidden absolute inset-0 flex-col items-center justify-center p-6 text-center bg-zinc-900">
                            <div class="h-16 w-16 rounded-2xl bg-white/5 flex items-center justify-center mb-4">
                                <i class="fa-regular fa-file-lines text-2xl text-zinc-500"></i>
                            </div>
                            <p class="text-sm text-zinc-400 mb-2">Preview not available for this file type.</p>
                            <a href="{{ document.file.url }}" target="_blank" class="px-4 py-2 bg-violet-600 rounded-lg text-xs font-bold text-white hover:bg-violet-500 transition">
                                Download to View
                            </a>
                        </div>
                    </div>
                </aside>

            </div>
        </main>
    </div>

    <script>
        const DOCUMENT_ID = {{ document.id }};
        let chatSocket = null;
        let isConnecting = false;

        // Initialize WebSocket connection
        function initWebSocket() {
            if (isConnecting || chatSocket) return;
            
            isConnecting = true;
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/chat/${DOCUMENT_ID}/`;
            
            console.log('Connecting to WebSocket:', wsUrl);
            updateStatus('connecting');

            chatSocket = new WebSocket(wsUrl);

            chatSocket.onopen = function(e) {
                console.log('WebSocket connection established');
                updateStatus('connected');
                isConnecting = false;
            };

            chatSocket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                handleWebSocketMessage(data);
            };

            chatSocket.onerror = function(error) {
                console.error('WebSocket error:', error);
                updateStatus('disconnected');
            };

            chatSocket.onclose = function(e) {
                console.log('WebSocket closed:', e.code);
                updateStatus('disconnected');
                isConnecting = false;
                
                // Attempt to reconnect
                setTimeout(() => {
                    if (!chatSocket || chatSocket.readyState === WebSocket.CLOSED) {
                        initWebSocket();
                    }
                }, 3000);
            };
        }

        function updateStatus(status) {
            const statusEl = document.getElementById('ws-status');
            const dotEl = statusEl.querySelector('.status-dot');
            const textEl = statusEl.querySelector('span:last-child');
            
            dotEl.className = `status-dot ${status}`;
            
            if (status === 'connected') {
                statusEl.className = 'flex items-center gap-2 rounded-full border border-green-500/20 bg-green-500/10 px-3 py-1 text-xs text-green-400 backdrop-blur-md transition-colors';
                textEl.textContent = 'Connected';
            } else if (status === 'disconnected') {
                statusEl.className = 'flex items-center gap-2 rounded-full border border-red-500/20 bg-red-500/10 px-3 py-1 text-xs text-red-400 backdrop-blur-md transition-colors';
                textEl.textContent = 'Reconnecting...';
            } else {
                statusEl.className = 'flex items-center gap-2 rounded-full border border-white/5 bg-black/20 px-3 py-1 text-xs text-zinc-400 backdrop-blur-md transition-colors';
                textEl.textContent = 'Connecting...';
            }
        }

        function handleWebSocketMessage(data) {
            const type = data.type;

            if (type === 'user_message') {
                addMessageToUI(data.content, 'user', data.id);
            } else if (type === 'ai_thinking') {
                addLoadingIndicator();
            } else if (type === 'ai_message') {
                removeLoadingIndicator();
                addMessageToUI(data.content, 'assistant', data.id);
            } else if (type === 'error') {
                removeLoadingIndicator();
                showError(data.message);
            }
        }

        function addMessageToUI(content, role, id) {
            const messagesDiv = document.getElementById('chat-messages');
            const msgDiv = document.createElement('div');
            
            // Flex alignment
            msgDiv.className = 'w-full flex msg-animate ' + (role === 'user' ? 'justify-end' : 'justify-start');
            msgDiv.id = `msg-${id}`;

            // Modern Bubble Styles
            const contentDiv = document.createElement('div');
            contentDiv.className = `relative px-5 py-3.5 rounded-2xl max-w-[85%] sm:max-w-[75%] text-sm leading-relaxed shadow-lg ${
                role === 'user' 
                    ? 'bg-gradient-to-br from-violet-600 to-indigo-600 text-white rounded-br-none' 
                    : 'bg-zinc-900/70 backdrop-blur-md border border-white/10 text-zinc-100 markdown-body rounded-bl-none'
            }`;

            if (role === 'user') {
                contentDiv.textContent = content;
            } else {
                contentDiv.innerHTML = `<div class="markdown-content">${marked.parse(content)}</div>`;
            }

            msgDiv.appendChild(contentDiv);
            messagesDiv.appendChild(msgDiv);
            scrollToBottom();
        }

        function addLoadingIndicator() {
            const messagesDiv = document.getElementById('chat-messages');
            const loaderDiv = document.createElement('div');
            loaderDiv.id = 'loading-indicator';
            loaderDiv.className = 'w-full flex justify-start msg-animate';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'px-4 py-3 rounded-2xl bg-zinc-900/50 backdrop-blur-sm border border-white/5 text-gray-200 rounded-bl-none';
            contentDiv.innerHTML = '<div class="typing-indicator"><span></span><span></span><span></span></div>';

            loaderDiv.appendChild(contentDiv);
            messagesDiv.appendChild(loaderDiv);
            scrollToBottom();
        }

        function removeLoadingIndicator() {
            const loader = document.getElementById('loading-indicator');
            if (loader) loader.remove();
        }

        function handleSendMessage(e) {
            e.preventDefault();

            const textarea = document.getElementById('message-input');
            const sendBtn = document.getElementById('send-btn');
            const content = textarea.value.trim();

            if (!content || !chatSocket || chatSocket.readyState !== WebSocket.OPEN) {
                if (!chatSocket || chatSocket.readyState !== WebSocket.OPEN) {
                    showError('Connection lost. Please wait...');
                }
                return;
            }

            sendBtn.disabled = true;

            chatSocket.send(JSON.stringify({
                'type': 'chat_message',
                'content': content
            }));

            textarea.value = '';
            textarea.style.height = 'auto';

            sendBtn.disabled = false;
        }

        function showError(message) {
            const messagesDiv = document.getElementById('chat-messages');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'mx-auto max-w-3xl mb-4 p-3 rounded-lg bg-red-500/10 border border-red-500/20 text-red-300 text-sm text-center';
            errorDiv.textContent = message;
            messagesDiv.appendChild(errorDiv);
            scrollToBottom();
        }

        function scrollToBottom() {
            const container = document.getElementById('chat-container');
            if (container) {
                setTimeout(() => {
                    container.scrollTop = container.scrollHeight;
                }, 0);
            }
        }

        // Auto-resize textarea
        const textarea = document.getElementById('message-input');
        if (textarea) {
            textarea.addEventListener('input', function () {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 150) + 'px';
            });
            textarea.addEventListener('keydown', function (e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    document.getElementById('chat-form').dispatchEvent(new Event('submit'));
                }
            });
        }

        // Sidebar functions
        function toggleMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const backdrop = document.getElementById('mobile-backdrop');
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
                backdrop.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                backdrop.classList.add('hidden');
            }
        }

        function toggleDesktopSidebar() {
            document.getElementById('sidebar').classList.toggle('sidebar-collapsed');
        }

        function switchMobileTab(tab) {
            const chatView = document.getElementById('chat-view-wrapper');
            const docView = document.getElementById('doc-view-wrapper');
            const btnChat = document.getElementById('tab-btn-chat');
            const btnDoc = document.getElementById('tab-btn-doc');

            if (tab === 'chat') {
                chatView.classList.remove('hidden');
                docView.classList.add('hidden');
                docView.classList.remove('mobile-active');
                btnChat.classList.add('tab-active');
                btnChat.classList.remove('tab-inactive');
                btnDoc.classList.remove('tab-active');
                btnDoc.classList.add('tab-inactive');
            } else {
                chatView.classList.add('hidden');
                docView.classList.remove('hidden');
                docView.classList.add('mobile-active');
                btnDoc.classList.add('tab-active');
                btnDoc.classList.remove('tab-inactive');
                btnChat.classList.remove('tab-active');
                btnChat.classList.add('tab-inactive');
            }
        }

        // Initialize WebSocket on page load
        document.addEventListener('DOMContentLoaded', function() {
            initWebSocket();
            renderMarkdown();
            scrollToBottom();
        });

        function renderMarkdown() {
            document.querySelectorAll('.markdown-content').forEach(el => {
                if (!el.dataset.rendered) {
                    el.innerHTML = marked.parse(el.textContent);
                    el.dataset.rendered = 'true';
                }
            });
        }

        // Cleanup WebSocket on page unload
        window.addEventListener('beforeunload', function() {
            if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
                chatSocket.close();
            }
        });
    </script>
</body>
</html>